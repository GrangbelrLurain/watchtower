---
description: "프록시 연결하기" 버튼 → 브라우저에서 SSL 다운로드·리버스 프록시 설정 자동 지원 가능 여부 검토
---

# 프록시 연결하기 버튼 — SSL 다운로드·설정 페이지 검토

Watchtower를 켜 둔 상태에서 **「프록시 연결하기」** 버튼을 누르면, 브라우저가 **SSL 다운로드** 및 **리버스 프록시 설정**을 안내/제공하는 페이지로 자동 이동하도록 할 수 있는지 검토한 문서입니다.

**관련 문서**: [06-proxy-architecture.md](06-proxy-architecture.md), [05-domain-local-routing.md](05-domain-local-routing.md) (SSL 다운로드·설정 안내)

---

## 1. 요구 동작 정리

| 동작 | 설명 |
|------|------|
| 버튼 클릭 | Watchtower 앱에서 「프록시 연결하기」 클릭 |
| 브라우저 자동 오픈 | 기본 브라우저가 특정 URL로 열림 |
| 해당 URL에서 제공 | (1) **SSL(인증서/CA) 다운로드**, (2) **리버스 프록시 설정** 안내 또는 자동화 |

---

## 2. 가능 여부 요약

| 항목 | 가능 여부 | 비고 |
|------|-----------|------|
| 버튼 클릭 시 브라우저로 URL 오픈 | **가능** | 이미 `tauri-plugin-opener` 사용 중. `open_url("http://127.0.0.1:8080/...")` 로 기본 브라우저 실행 가능. |
| 오픈할 URL을 **프록시가 직접 서빙** | **가능** | 프록시에 **예약 경로**(예: `/.watchtower/setup`)를 두고, 이 경로로 오는 요청은 **로컬 라우트로 포워드하지 않고** 프록시가 HTML/파일 응답. |
| SSL(CA/인증서) 다운로드 | **가능** | 예약 경로에 `/.watchtower/ca.pem` 등으로 CA 또는 인증서 파일 응답. CA 생성·저장 후 해당 경로에서 서빙. |
| 리버스 프록시 설정 “자동” 지원 | **가능** | (1) **안내 페이지**: 포워드/리버스 주소·설정 방법 문구. (2) **PAC URL 제공**: 브라우저에 PAC 주소만 넣으면, 프록시가 PAC 파일을 서빙해 “어떤 호스트는 프록시 경유” 등 규칙 전달. (완전 자동은 OS별 프록시 설정 권한 이슈 있음) |

**결론: 구현 가능하다.** 아래는 전제 조건과 구현 포인트만 정리한 것이다.

---

## 3. 전제 조건

1. **프록시가 기동 중**이어야 함. (리버스 HTTP 또는 HTTPS 포트가 열려 있어야 「설정 페이지」 URL에 접속 가능.)
2. **오픈할 URL**은 리버스 포트 기준이면 됨.  
   - 예: 리버스 HTTP 8080 사용 시 → `http://127.0.0.1:8080/.watchtower/setup`  
   - 리버스 HTTPS 8443만 사용 시 → `https://127.0.0.1:8443/.watchtower/setup` (최초 1회는 인증서 경고 가능)
3. 리버스 포트를 **쓰지 않으면** 설정 페이지 URL을 제공할 수 없으므로, 버튼은 「리버스 포트가 설정·기동된 경우에만 활성화」 또는 「리버스 포트가 없으면 먼저 설정하라」 안내가 필요함.

---

## 4. 구현 포인트

### 4.1 버튼 클릭 → 브라우저 오픈

- **Tauri**: `tauri-plugin-opener` 로 URL 오픈. (이미 사용 중.)
- **오픈할 URL**:  
  - `http://127.0.0.1:{reverse_http_port}/.watchtower/setup`  
  - 또는 리버스 HTTP가 없으면 `https://127.0.0.1:{reverse_https_port}/.watchtower/setup`  
- **Command**: 예) `open_proxy_setup_page()` → `get_proxy_status()` 로 리버스 포트 확인 후, 해당 URL을 `opener`로 오픈.  
- **FE**: 「프록시 연결하기」 버튼 → `invoke("open_proxy_setup_page")` 호출.

### 4.2 프록시에서 예약 경로 서빙 (설정 페이지·SSL·PAC)

- **현재**: 요청은 Host 기준으로만 라우팅되고, **경로 기준 분기**는 없음.
- **필요**:  
  - `GET /.watchtower/setup` (또는 `/.watchtower/`) → **설정 안내 HTML** 응답.  
  - `GET /.watchtower/ca.pem` (또는 `/.watchtower/cert.pem`) → **CA 또는 인증서 파일** 응답 (Content-Type 등 적절히).  
  - (선택) `GET /.watchtower/proxy.pac` → **PAC 파일** 응답.  
- **구현 방식**:  
  - `proxy_handler`(또는 리버스 전용 진입점) **앞단**에서 `uri.path().starts_with("/.watchtower/")` 인지 검사.  
  - 해당하면 **로컬 라우트로 포워드하지 않고**, 경로별로 분기해 HTML/파일/PAC 응답을 직접 반환.  
  - 그 외는 기존대로 Host 기준 라우팅.

### 4.3 SSL 다운로드 (CA / 인증서)

- **목적**: 사용자가 브라우저(또는 OS)에 CA/인증서를 설치해, 리버스 HTTPS(8443) 등에서 우리가 제공하는 인증서를 신뢰하게 함.
- **방식 (2가지 중 선택)**  
  | 방식 | 설명 | 난이도 |
  |------|------|--------|
  | **A. CA 1개 생성·다운로드** | 앱에서 **Root CA** 1개 생성해 `app_data_dir` 등에 저장. 동적 인증서는 이 CA로 서명. 설정 페이지에서 「CA 다운로드」 링크 → `/.watchtower/ca.pem` 서빙. 사용자는 CA만 한 번 설치. | 중 (rcgen 등으로 CA 생성·저장, 동적 cert를 CA로 서명하도록 기존 로직 수정) |
  | **B. 호스트별 인증서 다운로드** | 현재처럼 호스트별 self-signed 인증서 생성. 설정 페이지에서 “특정 도메인(예: dev.modetour.local) 인증서” 다운로드 링크 제공. 도메인마다 한 번씩 설치. | 하 (이미 동적 생성 있음; 해당 호스트용 cert를 한 번 생성해 파일로 내려주는 경로만 추가) |
- **권장**: 장기적으로는 **A(CA)** 가 사용성 좋음. 단기에는 **B**로 시작해, 나중에 A로 확장 가능.

### 4.4 리버스 프록시 설정 “자동” 지원

- **완전 자동**(시스템 프록시를 앱이 직접 설정)은 OS·권한 이슈가 있어 범용 구현 부담이 큼.
- **반자동**으로 다음은 가능.  
  - **설정 페이지 HTML**에 다음 안내:  
    - 포워드 프록시 주소: `127.0.0.1:{proxy_port}`  
    - 리버스 접속 주소: `http://127.0.0.1:{reverse_http_port}` / `https://127.0.0.1:{reverse_https_port}`  
    - “브라우저 프록시를 수동으로 127.0.0.1:3300 으로 설정” 또는 “아래 PAC URL 사용” 문구.  
  - **PAC URL** 제공:  
    - 예: `http://127.0.0.1:8080/.watchtower/proxy.pac`  
    - 브라우저에서 “자동 설정 스크립트”에 위 URL 입력하면, 브라우저가 이 URL을 요청하고, 프록시가 **PAC 파일 내용**(JavaScript)을 응답.  
    - PAC 안에서 “로컬 라우트 도메인 목록은 프록시 경유, 나머지는 DIRECT” 등 규칙을 넣을 수 있음. (도메인 목록은 프록시가 라우트 테이블에서 읽어 PAC 내용을 동적으로 생성하면 됨.)

---

## 5. 데이터·설정

| 항목 | 내용 |
|------|------|
| **CA 저장** (방식 A 선택 시) | `app_data_dir` 아래 예: `watchtower_ca.pem`, `watchtower_ca_key.pem` 등. 최초 1회 생성 후 재사용. |
| **예약 경로 prefix** | `/.watchtower/` 권장. (다른 앱과 충돌 가능성 낮고, 로컬 라우트 path와 겹치기 어려움.) |
| **프록시 상태** | 리버스 HTTP/HTTPS 포트는 이미 `get_proxy_status` 등으로 알 수 있으므로, 오픈할 URL 결정에 그대로 사용. |

---

## 6. 체크리스트 (구현 시)

| 구분 | 항목 |
|------|------|
| BE | 프록시에서 `/.watchtower/*` 예약 경로 처리 (설정 페이지 HTML, CA/cert, PAC 응답). Host 라우팅보다 **먼저** 경로 검사. |
| BE | (선택) Root CA 생성·저장·동적 인증서 CA 서명 전환. 또는 호스트별 인증서 다운로드 경로. |
| BE | `open_proxy_setup_page` Command: 리버스 포트 확인 후 기본 브라우저로 `http(s)://127.0.0.1:{port}/.watchtower/setup` 오픈. |
| FE | 「프록시 연결하기」 버튼 추가 → `invoke("open_proxy_setup_page")`. (리버스 미기동 시 비활성화 또는 안내.) |
| FE | (향후) 설정 페이지 URL을 **QR 코드**로 표시 → Android / iPhone 스캔 시 같은 설정 페이지 오픈. |
| BE | (향후) 모바일 접속용: 리버스 포트 **0.0.0.0** 바인딩 옵션, **LAN IP 조회** 또는 설정 페이지 URL 반환 API. |
| 문서 | 06/05와 정합성 유지 (설정 페이지가 05의 “SSL 다운로드·설정 안내” 역할 일부 수행). |

---

## 7. 요약

- **가능하다.**  
  - 버튼 클릭 → 브라우저 오픈: **tauri-plugin-opener**로 가능.  
  - SSL 다운로드·리버스 프록시 설정 안내: **프록시가 예약 경로(`/.watchtower/`)로 직접 응답**하면 가능.  
- **필수 변경**: 프록시에 **경로 기반 분기** 추가(예약 경로는 포워드하지 않고 직접 응답).  
- **선택**: CA 1개 생성 후 다운로드 제공(권장), PAC URL로 “자동 설정” 스크립트 제공.  
- 리버스 포트가 없으면 설정 페이지 URL을 쓸 수 없으므로, 버튼 노출/활성화는 **리버스 포트 사용 여부**와 연동하는 것이 좋다.

이 검토를 바탕으로 06 기획안에 「프록시 연결하기 → 설정 페이지·SSL 다운로드」 플로우를 추가하고, 구현 단계에서 위 체크리스트를 참고하면 된다.

---

## 8. QR 코드 지원 (Android / iPhone 연결) — 향후 세팅

나중에 **해당 설정 페이지 URL로 연결하는 QR 코드**를 지원해, **Android / iPhone**에서 스캔하면 모바일 브라우저가 설정 페이지(SSL 다운로드·리버스 프록시 설정 안내)로 열리도록 할 수 있다.

### 8.1 동작 흐름

| 단계 | 설명 |
|------|------|
| 1 | Watchtower 설정 페이지 또는 「프록시 연결하기」 근처에 **QR 코드** 표시. |
| 2 | QR 코드에 들어가는 URL = **설정 페이지 URL**. (PC에서 쓰는 `127.0.0.1` 대신 **같은 PC의 LAN IP** 사용.) |
| 3 | 사용자가 **Android / iPhone**으로 QR 스캔 → 모바일 브라우저가 해당 URL 오픈. |
| 4 | 모바일에서도 **동일한 설정 페이지**(SSL 다운로드, 프록시 설정 안내) 제공. CA 설치 후 모바일에서 리버스 HTTPS 접속·프록시 사용 가능. |

### 8.2 전제 조건 (모바일에서 접속하려면)

| 조건 | 내용 |
|------|------|
| **리버스 포트를 LAN에서 수신** | 현재 프록시는 `127.0.0.1` 만 리스닝. 모바일이 PC에 접속하려면 **같은 LAN 대역**에서 접근 가능해야 하므로, 리버스 포트를 **0.0.0.0** 또는 **LAN IP**로 바인딩하는 확장이 필요함. (05·06에서 언급한 “바인딩 확장”과 동일.) |
| **설정 페이지 URL에 LAN IP 사용** | QR에 넣을 URL은 `http://{LAN_IP}:{reverse_http_port}/.watchtower/setup` 형태. 예: `http://192.168.0.10:8080/.watchtower/setup`. |
| **LAN IP 획득** | PC의 LAN IP(예: 192.168.x.x)를 앱에서 조회해, 그 값을 사용해 URL·QR 생성. (OS별 API 또는 네트워크 인터페이스 열거.) |

### 8.3 구현 포인트 (향후)

| 구분 | 항목 |
|------|------|
| BE | 리버스 HTTP/HTTPS 리스너를 **0.0.0.0** (또는 설정 가능한 bind 주소)로 옵션 확장. |
| BE | **LAN IP 조회** (또는 “설정 페이지 접속용 URL” 반환) API. 예: `get_proxy_setup_url()` → `http://{lan_ip}:{port}/.watchtower/setup`. |
| FE | 설정 페이지 URL을 **QR 코드**로 표시. (QR 라이브러리로 URL 문자열 → QR 이미지 생성. Android/iOS 모두 URL QR이면 카메라로 열림.) |
| 보안 | 0.0.0.0 바인딩 시 같은 LAN 내 다른 기기 접근 가능하므로, 필요 시 “모바일 연결용” 옵션으로 켜고 안내 문구 명시. |

### 8.4 정리

- **같은 설정 페이지 URL**을 PC 브라우저(버튼 클릭)와 모바일(QR 스캔)에서 공유하면 됨.  
- **PC**: `http://127.0.0.1:{port}/.watchtower/setup`  
- **모바일(QR)**: `http://{LAN_IP}:{port}/.watchtower/setup`  
- 설정 페이지·SSL 다운로드·PAC 등 서빙 로직은 동일; **QR은 “그 URL을 쉽게 열기 위한 수단”**으로만 추가하면 됨.  
- 리버스 포트를 LAN에 열고, LAN IP를 구해 URL을 만들 수 있으면 **QR 지원은 FE에서 QR 생성만 추가**하면 됨.
