---
description: 3단계 — 도메인을 로컬 서버로 연결하는 기능(도메인 로컬 라우팅/DNS) 구현에 필요한 항목
---

# 3단계: 도메인 로컬 서버 DNS 연결 — 필요 항목

[ROADMAP.md](../ROADMAP.md) 3단계 **도메인 프록시 및 트래픽 변조** 중, **도메인 로컬 라우팅**을 구현하기 위해 필요한 것들을 정리한 문서입니다.

**목표**: 특정 도메인을 로컬 서버로 연결하여 멀티 도메인 기능 테스트·엔드포인트 Mocking·실제 백엔드 전환 테스트를 가능하게 한다.

---

## 0. 미래 시나리오와 리버스 프록시 적합성

다음 세 가지가 **모두** 가능해야 한다.

| 시나리오 | 설명 |
|----------|------|
| **A. 내 컴퓨터** | 특정 도메인 접속 → 로컬 서버로 연결 |
| **B. 모바일 기기** | 내 컴퓨터에서 QR 찍으면 SSL 다운로드 받고, 특정 도메인을 내 로컬 서버로 연결 |
| **C. 외부 기기** | 내 IP의 특정 라우팅으로 연결 시 SSL 다운로드 받고, 특정 도메인을 내 로컬 서버로 연결 |

### 리버스 프록시로 가는 것이 적합한가?

**결론: 예. 하나의 “프록시(리버스 프록시)” 서비스로 세 시나리오를 통일할 수 있고, 대안보다 구현·운영이 단순하다.**

- **역할 정리**
  - 클라이언트(브라우저/앱)가 **어떤 도메인**으로 요청하든, 그 요청이 **우리 프로세스**로 들어오게만 하면 된다.
  - 우리는 **Host(또는 SNI)** 를 보고 “이 도메인 → 이 로컬 host:port” 라우팅 테이블을 적용해 **로컬 서버로 프록시**하면 된다.
  - 즉, “요청을 받아서 Host 기준으로 로컬로 넘기는 서버” = **리버스 프록시**가 핵심이다.

- **시나리오별로 보면**
  - **A (내 컴퓨터)**: 클라이언트가 우리를 **HTTP 프록시**로 설정(예: `127.0.0.1:8888`). 요청이 우리로 들어옴 → Host 기준 라우팅 → 로컬 서버로 전달. (클라이언트 입장에선 “프록시”, 우리 입장에선 “받은 요청을 로컬로 넘김” = 리버스 프록시 역할.)
  - **B (모바일)**: QR로 “프록시 주소 + 인증서 다운로드 URL” 전달. 기기가 우리 PC의 **IP:포트**를 프록시로 설정하고, **SSL 다운로드**로 우리 CA/인증서를 설치해 HTTPS를 신뢰. 이후 동일: 요청이 우리로 들어오면 Host 기준으로 로컬 서버로 프록시.
  - **C (외부 기기)**: “내 IP + 특정 라우팅(경로/포트)”로 접속해 **SSL 다운로드** 후, 해당 엔드포인트를 프록시로 사용하거나, DNS/라우팅으로 우리 IP로 유도. 역시 요청이 우리로 들어오면 Host 기준 리버스 프록시.

- **대안과 비교**
  - **hosts / DNS만**: “도메인 → 내 IP”로만 바꿔주면, 결국 **내 IP에서 그 도메인 요청을 받아서 로컬로 넘겨줄 서버**가 필요하다. 그 서버가 곧 리버스 프록시이므로, “리버스 프록시를 쓰지 않는다”는 선택지는 없다.
  - **순수 터널(CONNECT만)**: HTTPS는 SNI/Host를 암호화 구간 안에 넣어 보내므로, “어디로 터널링할지”를 알려면 우리가 TLS를 한 번 풀어야 한다. 풀면 우리가 인증서를 제공해야 하고(SSL 다운로드 = 이 인증서/CA 신뢰), 그 다음 Hop은 우리→로컬 서버이므로, 결국 **TLS 종료 + Host 기반 라우팅** = 리버스 프록시 구조가 된다.

- **미래 확장 시 필요한 것 (요약)**
  - **동일 서비스, 바인딩만 확장**: 현재는 `127.0.0.1:8888`만 써도 되고, B/C를 위해 **같은 라우팅 로직**을 `0.0.0.0:포트`(또는 LAN 전용 IP)에서도 리스닝하면 된다.
  - **SSL 다운로드**: 우리가 **CA + 도메인별 인증서 발급**을 하거나, 와일드카드/다중 SAN 인증서를 두고, “인증서/CA 설치 페이지”를 제공(QR 또는 “내 IP + 특정 라우팅”에서 제공). 모바일/외부 기기는 그걸 설치한 뒤 우리 주소를 프록시(또는 도메인 목적지)로 사용.
  - **발견(Discovery)**: B는 QR(프록시 URL + 인증서 다운로드 링크), C는 “내 IP + 경로”(예: `https://내IP:8443/setup`)로 같은 인증서 다운로드·설정 안내.

따라서 **지금 설계하는 “로컬 리버스 프록시 + Host 기반 라우팅”을 핵심으로 두고**,  
- 1차: 같은 PC만(127.0.0.1, HTTP 프록시 설정),  
- 2차: 바인딩 확장(0.0.0.0/LAN) + TLS(CA·인증서) + SSL 다운로드 UI + QR/외부 URL 안내  
로 확장하는 흐름이 적합하다.

---

## 1. 개요: 동작 방식

- **사용자 시나리오**: "`api.example.com`으로 가는 요청을 내 로컬 `localhost:3000`으로 보내고 싶다."
- **구현 방향 (권장)**:
  - Watchtower가 **로컬 리버스 프록시**를 띄운다 (예: `127.0.0.1:8888`).
  - 사용자는 브라우저/시스템 **HTTP 프록시**를 `127.0.0.1:8888`로 설정한다.
  - 프록시는 **Host 헤더**를 보고, 등록된 **도메인 → 로컬 타겟** 매핑이 있으면 해당 로컬 서버로 요청을 포워드하고, 없으면 그대로 외부로 전달한다.
- **대안**: OS **hosts 파일**에 `127.0.0.1 api.example.com` 추가 후, 80/443에서 리버스 프록시가 Host별로 로컬 포트에 전달. (hosts 편집 시 관리자 권한·복원 정책 필요.)

---

## 2. 백엔드 (BE) 필요 항목

### 2.1 데이터 모델

| 모델 | 필드 | 비고 |
|------|------|------|
| **DomainLocalRoute** (또는 `LocalRoute`) | `id`, `domain` (호스트명), `target_host` (예: 127.0.0.1), `target_port`, `enabled` (bool) | 도메인 → 로컬 (host:port) 매핑 |
| (선택) Mock/Override | `path_pattern`, `mock_response`, `status_code` 등 | 엔드포인트 더미 데이터(Mocking)용 — 2차 스코프 가능 |

- **저장소**: `app_data_dir/domain_local_routes.json` (또는 `local_routes.json`) — 목록 영구 저장.
- **네이밍**: 기존 plans의 join 테이블 규칙과 무관한 단일 엔티티이므로 `*_link` 불필요.

### 2.2 서비스 레이어

| 서비스 | 역할 |
|--------|------|
| **DomainLocalRouteService** (또는 LocalRouteService) | CRUD, JSON 읽기/쓰기, 프록시 서버에 현재 라우트 테이블 전달 |
| **로컬 리버스 프록시** | TCP 리스닝, HTTP 요청 수신, Host 기반 라우팅 테이블 조회 후 타겟으로 프록시, 라우트 없으면 패스스루(또는 직접 연결) |

### 2.3 Tauri Commands (제안)

| Command | 설명 |
|---------|------|
| `get_local_routes` | 전체 도메인→로컬 라우트 목록 조회 |
| `add_local_route` | 라우트 추가 (domain, target_host, target_port, optional enabled) |
| `update_local_route` | id로 수정 (domain, target_host, target_port, enabled) |
| `remove_local_route` | id로 삭제 |
| `set_local_route_enabled` | id, enabled로 활성화/비활성화 |
| `get_proxy_status` | 프록시 서버 동작 여부, 리스닝 포트 반환 |
| `start_local_proxy` | 프록시 서버 기동 (포트 설정 가능) |
| `stop_local_proxy` | 프록시 서버 중지 |

### 2.4 권한·환경

- **네트워크**: 로컬 리스닝을 위해 Tauri **권한** 또는 capability에서 `localhost` 바인딩 허용.
- **포트**: 기본 포트(예: 8888) 설정 가능, 충돌 시 사용자 알림 또는 대체 포트 제안.
- **(선택) hosts 파일**: hosts 편집 기능을 넣을 경우 관리자 권한·백업·복원 정책 필요 — 별도 스코프로 두어도 무방.

### 2.5 기술 선택지 (Rust)

- HTTP 프록시 구현: **hyper**, **reqwest** (클라이언트), **tokio** (비동기). 또는 **axum** 등으로 인입 받고 upstream으로 프록시.
- 프록시 서버는 **앱 생명주기**와 연동: 앱 시작 시 옵션으로 기동, 종료 시 정리.

---

## 3. 프론트엔드 (FE) 필요 항목

### 3.1 라우트·페이지

| 경로 (제안) | 역할 |
|-------------|------|
| `/proxy` | 도메인→로컬 라우트 목록·추가/수정/삭제·활성화 토글, 프록시 on/off 버튼 (domains와 분리하여 proxy 전용 라우트) |

- 기존 **도메인 목록**과는 별도: "모니터링 대상 도메인"과 "로컬로 라우팅할 도메인"은 개념이 다르므로, 같은 테이블로 묶을지 별도 설정 페이지로 둘지 결정 필요. (권장: 별도 **로컬 라우팅 설정** 페이지.)

### 3.2 UI 컴포넌트·기능

- **라우트 목록 테이블/리스트**: 도메인, 타겟(host:port), 활성화 토글, 수정/삭제.
- **라우트 추가 폼**: 도메인(호스트명), target_host, target_port 입력, 저장.
- **프록시 상태 표시**: 실행 중/중지, 리스닝 포트.
- **프록시 기동/중지 버튼** (또는 토글).
- **"프록시 사용 방법" 안내 패널**: 브라우저/시스템에서 HTTP 프록시를 `127.0.0.1:<port>`로 설정하는 방법 요약 (OS별·브라우저별 링크 또는 스텝).

### 3.3 엔티티·타입

- **LocalRoute** (또는 DomainLocalRoute): `id`, `domain`, `target_host`, `target_port`, `enabled` — 01-backend-api.md 스타일로 FE 타입 정의.

### 3.4 FE–BE 연동

- `invoke("get_local_routes")`, `invoke("add_local_route", { ... })` 등 위 Commands 호출.
- 인자 네이밍: **snake_case** (04-fe-be-connection.md 준수).
- ApiResponse<T> 패턴 유지.

---

## 4. 선행 조건·의존성

- **2단계와의 관계**: 2단계(로컬 SSL, 디바이스 브릿지)가 완료되면, HTTPS 로컬 서버로의 라우팅·인증서 검증 이슈를 같이 다룰 수 있음. 3단계 1차 스코프는 **HTTP + 로컬 호스트**만 지원해도 가능.
- **1단계**: 이미 도메인·그룹·상태 체크가 있으므로, "로컬 라우팅 대상"은 별도 설정으로 두고, 필요 시 나중에 도메인 목록과 연결(예: "이 도메인을 로컬로 라우팅" 체크) 확장 가능.

---

## 5. 체크리스트 요약

| 구분 | 항목 |
|------|------|
| **BE** | DomainLocalRoute(또는 LocalRoute) 모델·저장소(JSON) |
| **BE** | DomainLocalRouteService (CRUD) |
| **BE** | 로컬 HTTP 리버스 프록시 서버 (Host 기반 라우팅) |
| **BE** | get_local_routes, add_local_route, update_local_route, remove_local_route, set_local_route_enabled |
| **BE** | get_proxy_status, start_local_proxy, stop_local_proxy |
| **BE** | 네트워크 리스닝 권한·포트 설정 |
| **FE** | 로컬 라우팅 설정 페이지 (라우트 목록·CRUD·활성화 토글) |
| **FE** | 프록시 기동/중지·상태 표시 |
| **FE** | 프록시 설정 방법 안내 UI |
| **FE** | LocalRoute 엔티티 타입·invoke 연동 |
| **(선택)** | hosts 파일 편집·복원 (2차 스코프) |
| **(선택)** | 경로별 Mock 응답 (2차 스코프) |

---

## 6. 미래 확장 (B·C 시나리오) 시 필요 항목

리버스 프록시를 그대로 두고 아래를 추가하면 된다.

| 구분 | 항목 |
|------|------|
| **BE** | 프록시 리스닝을 `0.0.0.0`(또는 LAN IP)로 확장 — 모바일/외부 기기 접근 |
| **BE** | TLS 종료: CA 생성·도메인별(또는 SAN) 인증서 발급, HTTPS 리스닝 |
| **BE** | 인증서/CA 파일 노출 API 또는 정적 경로 — “SSL 다운로드” 제공 |
| **FE** | SSL 다운로드 페이지: CA/인증서 설치 안내 + 다운로드 링크 |
| **FE** | QR 생성: (프록시 주소 + SSL 다운로드 URL) — 모바일에서 스캔 후 설정 |
| **FE** | “외부 기기 연결” 안내: 내 IP + 특정 라우팅(경로/포트), SSL 다운로드 링크 |
| **설정** | 방화벽/포트 포워딩 안내 (외부 기기가 내 IP로 접근하려면 필요) |

---

참고: [ROADMAP.md](../ROADMAP.md) 3단계, [03-roadmap-tasks.md](03-roadmap-tasks.md).
