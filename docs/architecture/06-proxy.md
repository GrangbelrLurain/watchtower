---
title: 프록시 기능
description: 프록시 아키텍처, 포워드/리버스, 로컬 라우팅, 상시 동작, 트래픽 흐름
keywords: [프록시, 아키텍처, 로컬라우팅, 포워드, 리버스, TLS]
when: 프록시 구현·구조 파악 시
---

# 프록시 기능

Watchtower 로컬 프록시의 아키텍처, 라우팅, 트래픽 흐름을 정리합니다.

---

## 1. 설계 원칙

### 1.1 프록시 상시 동작

- **프록시는 앱이 켜져 있으면 항상 작동한다.**
- Proxy 대시보드의 **on/off 스위치**는 프록시 자체가 아니라 **"로컬 라우팅" 활성화 여부**를 토글.
  - **On**: 등록된 도메인 요청을 로컬 서버로 라우팅
  - **Off**: 모든 요청을 원래 서버로 패스스루 (프록시는 계속 동작)
- API 로깅은 프록시가 항상 동작하는 전제에서 작동.

### 1.2 라우팅 판단

**"로컬로 보낼지 / 실제로 보낼지"는 항상 프록시 서버가 결정한다.** 클라이언트는 "프록시로 보낼지"만 정하고, 대상 호스트를 로컬로 연결할지는 프록시가 판단.

---

## 2. 포트 구성

```
┌────────────────────────────────────────────────────────────┐
│                 Watchtower 프록시 (127.0.0.1)               │
├──────────────────┬──────────────────┬──────────────────────┤
│ 포워드 프록시     │ 리버스 HTTP       │ 리버스 HTTPS         │
│ (예: 8888)        │ (예: 8080, 옵션)  │ (예: 8443, 옵션)    │
│ CONNECT 지원      │ Host/127.0.0.1    │ TLS 종료            │
│ Host 기준 라우팅  │ → 로컬 라우트     │ Host 기준 → 로컬    │
└──────────────────┴──────────────────┴──────────────────────┘
```

| 포트 | 설정 필드 | 역할 |
|------|-----------|------|
| 포워드 프록시 | `proxy_port` | HTTP_PROXY로 지정. CONNECT(HTTPS) 포함, Host 기준 라우팅 |
| 리버스 HTTP | `reverse_http_port` (옵션) | 브라우저 직접 접속 (`http://127.0.0.1:port`). 호스트 파일 불필요 |
| 리버스 HTTPS | `reverse_https_port` (옵션) | TLS 종료 후 Host 기준 라우팅. 동적 인증서 |

---

## 3. 라우팅 규칙

| 조건 | 동작 |
|------|------|
| 로컬 라우팅 On + Host가 로컬 라우트 매칭 | `target_host:target_port`로 전달 |
| Host가 127.0.0.1 / localhost | 첫 번째 enabled 로컬 라우트로 전달 (리버스 접속용) |
| 그 외 (또는 로컬 라우팅 Off) | 패스스루 (실제 서버로 전달) |

CONNECT (HTTPS):
- 로컬 라우트 매칭 → TLS 종료 후 로컬 백엔드(HTTP)로 전달
- 매칭 없음 → 터널 유지

---

## 4. 트래픽 흐름

### 브라우저 → 로컬 서버 (리버스)

1. 리버스 HTTP 포트(8080) 설정 + 프록시 기동
2. 브라우저에서 `http://127.0.0.1:8080/` 접속
3. Host: 127.0.0.1 → 첫 번째 로컬 라우트(`127.0.0.1:3100`)로 전달
4. 로컬 서버 응답 → 브라우저에 로컬 앱 표시

### 로컬 서버 → 외부 API (포워드)

1. 로컬 서버가 `HTTP_PROXY=127.0.0.1:8888` 설정
2. `https://api.real.com/...` 요청 → 포워드 프록시로
3. Host `api.real.com` → 로컬 라우트 매칭 여부 확인 → 매칭이면 로컬, 없으면 실제 서버

---

## 5. 데이터 모델

| 모델 | 필드 | 비고 |
|------|------|------|
| LocalRoute | id, domain, target_host, target_port, enabled | 도메인 → 로컬 매핑 |
| ProxySettings | dns_server, proxy_port, reverse_http_port, reverse_https_port | 프록시 설정 |

---

## 6. 미래 확장

| 항목 | 설명 |
|------|------|
| 0.0.0.0 바인딩 | 모바일/외부 기기 접근 |
| CA + 인증서 다운로드 | SSL 다운로드 페이지 |
| QR 코드 | 모바일 설정 안내 |
| hosts 파일 편집 | 2차 스코프 |
